#!/bin/sh
# Tier 1: Enhanced pre-commit automation for documentation
# 1. Auto-stages all docs changes
# 2. Regenerates nav from canonical structure (tools/docs_tool.py)
# 3. Runs validation checks (YAML, brand, links)
# 4. Stages regenerated mkdocs.yml
# 5. Blocks commit if validation fails

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "ğŸ“‹ Pre-commit: Docs Automation & Validation"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

# 1. Auto-stage all docs changes
echo "âœ“ Staging docs/ directory changes..."
git add --all docs

# 2. Regenerate nav from canonical structure
echo "âœ“ Regenerating navigation structure..."
python3 tools/docs_tool.py generate-nav
if [ $? -eq 0 ]; then
    echo "  âœ… Navigation synced to canonical structure"
else
    echo "  âŒ Failed to regenerate navigation"
    exit 1
fi

# 3. Run validation checks
echo ""
echo "Running validation checks..."

# Check YAML structure
echo "  â€¢ Checking mkdocs.yml integrity..."
python3 tools/docs_tool.py check-yaml
YAML_RESULT=$?

# Check brand consistency  
echo "  â€¢ Checking brand consistency..."
python3 tools/docs_tool.py check-brand
BRAND_RESULT=$?

# Check internal links
echo "  â€¢ Checking internal links..."
python3 tools/docs_tool.py check-links
LINKS_RESULT=$?

# 4. Stage regenerated mkdocs.yml
echo ""
echo "âœ“ Staging regenerated mkdocs.yml..."
git add mkdocs.yml

# 5. Report results and decide whether to allow commit
echo ""
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

if [ $YAML_RESULT -ne 0 ] || [ $BRAND_RESULT -ne 0 ] || [ $LINKS_RESULT -ne 0 ]; then
    echo -e "${RED}âŒ Validation failed. Fix issues above and try again.${NC}"
    exit 1
fi

echo -e "${GREEN}âœ… All checks passed! Commit will proceed.${NC}"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
exit 0
